package events

// Generated automatically by microgen: do not edit manually

import (
    "time"
    "strconv"
)

{{range .GetEvents}}
type {{.NameToFirstUpper}} struct {
    {{range .Attributes}} {{.NameToFirstUpper}} {{.MultiplicityNsme}} {{.TypeName}} `json:"{{.Name}}"`
    {{end}}
}

func (event *{{.NameToFirstUpper}}) Wrap() *Envelope {
    envelope := new(Envelope)
    envelope.Type = Type{{.NameToFirstUpper}}
    envelope.{{.NameToFirstUpper}} = event
    envelope.AggregateName = "{{.AggregateName}}"
	envelope.AggregateUid = {{if .HasAggregateFieldTypeInt }}strconv.Itoa(event.{{.AggregateFieldNameToFirstUpper}}){{else}}event.{{.AggregateFieldNameToFirstUpper}}{{end}}
    envelope.SequenceNumber = 0 // TODO
    envelope.Timestamp = time.Now()
    return envelope
}
{{end}}

type Type int
const (
   TypeUnknown Type = iota
{{range .GetEvents}} Type{{.NameToFirstUpper}}
{{end}}
)

func (t Type) String() string {
	switch( t ) {
	{{range .GetEvents}}case Type{{.NameToFirstUpper}}: return "{{.NameToFirstUpper}}"
	{{end}}
	}
	return "unknown"
}

type Envelope struct {
    SequenceNumber uint64 `json:"sequenceNumber"`
    AggregateName string `json:"aggregateName"`
    AggregateUid string `json:"aggregateUid"`
    Timestamp time.Time `json:"timestamp"`
    Type Type `json:"type"`
{{range .GetEvents}} {{.NameToFirstUpper}} *{{.NameToFirstUpper}} `json:"{{.NameToFirstLower}}"`
{{end}}
}

type EventHandlerFunc func( Envelope *Envelope ) error

type PublishSubscriber interface {
    Subscribe( eventType Type, f EventHandlerFunc ) error
    Publish( Envelope *Envelope ) error
}

type StoredItemHandlerFunc func( envelope *Envelope ) bool

type Store interface {
    Store( envelope *Envelope ) error
    Iterate( StoredItemHandlerFunc ) error
}
